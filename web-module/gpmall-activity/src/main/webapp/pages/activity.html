<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta charset="utf-8"/>
    <title>咕泡云商城--幸运抽奖</title>
    <link rel="stylesheet" type="text/css" href="../resources/css/home.css">



</head>
<body>
<div class="sign">
    <div class="sign-right">
        <ul>
            <li><a href="#">返回首页</a></li>
            <li id="sign-right-2"><a href="javascript:;">幸运一把</a></li>
            <li id="sign-right-3"><a href="javascript:;">活动规则</a></li>
            <li id="sign-right-4"><a href="javascript:;">奖品详情</a></li>
            <li id="sign-right-5"><a href="javascript:;">返回顶部</a></li>
        </ul>
        <div class="sign-erweima">
            <img src="//cdn.gupaoedu.com/common/images/foot-weix.png"/>
            <p>扫一扫</p>
            <p>了解更多咕泡学院</p>
        </div>
    </div>

    <div class="sign-1">

    </div>
    <div class="sign-2" id="sign-2">
        <div class="sign-2-1">
          <p class="sign-p1" id="sign_logined">您目前拥有：<i>0</i>次抽奖机会</p>
        </div>
    </div>
    <div class="sign-3">
        <div class="wripe">
            <div class="sign-3-1"><img src="../resources/images/activity/sign_8.png"/></div>


<!--            <div class="turnplate">
                <canvas class="item" id="wheelcanvas" width="422px" height="422px"></canvas>
                <img class="pointer" src="../resources/images/activity/pointer.png" alt="award rotation start" />
            </div>-->

  <!--          <div class="turntable-bg">
                &lt;!&ndash;<div class="mask"><img src="images/award_01.png"/></div>&ndash;&gt;
                <div class="pointer"><img src="../resources/images/activity/pointer.png" alt="pointer"/></div>
                <div class="rotate" ><img id="rotate" src="../resources/images/activity/turntable.png" alt="turntable"/></div>
            </div>-->

            <div class="turntable-bg">
                <!--<div class="mask"><img src="images/award_01.png"/></div>-->
                <div class="pointer"><img src="../resources/images/activity/pointer.png" alt="pointer"/></div>
                <canvas class="item" id="wheelcanvas" width="586px" height="586px"></canvas>
            </div>

            <div class="sign-3-2">
                <h3>获奖记录</h3>
                <div class="sign-3-2-1">
                    <span class="span1">手机号</span>
                    <span class="span2">奖品</span>
                </div>
                <div class="sign-3-2-2">
                    <ul>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>
                        <li>134***--------------------iphone</li>

                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="sign-4">
        <div class="wripe">
            <h3>活动规则</h3>
            <p><i>1</i>此活动只允许平台会员参加。</p>
            <p><i>2</i>用户第1天签到，可获得10元体验金；第2天签到，可获15元；第3天签到，可获得20元；第4天签到，可获得25元；第5天签到，可获得30元；第6天签到，可获得35元；第7天签到，可获得35元……以此类推，连续第10天签到，累计共获得275元体验金，并获得1次抽奖机会； </p>
            <p><i>3</i>连续签到20天，可获得2次抽奖机会； 连续签到30天，可获得4次抽奖机会；</p>
            <p><i>4</i>若在此期间用户未连续签到，系统将自动从第1天计算签到金额；</p>
            <p><i>5</i>推荐好友注册，可获得2次抽奖机会；</p>
            <p><i>6</i>此活动时间期限为2016年6月16日至2016年7月16日； </p>
            <p><i>7</i>本活动最终解释权归湖南咕泡网络科技有限公司所有。</p>
        </div>
    </div>
    <div class="sign-5">
        <div class="wripe">
            <div class="sign-5-1"><img src="../resources/images/activity/sign_logo.png" width="300" height="100"/></div>
            <div class="sign-5-2">
                <p class="p1">湖南咕泡网络科技有限公司</p>
                <p class="p2">客服热线：0731-89729575</p>
                <p class="p2">公司网址：www.gupaoedu.com</p>
            </div>
        </div>
    </div>
</div>


<script src="/resources/js/jquery-1.7.2.min.js"></script>
<script src="../resources/js/layer/layer.js" type="text/javascript"></script>
<script type="text/javascript" src="/resources/js/activity/awardRotate.js"></script>
<script type="text/javascript">
    // 转盘区域
    var turnplate = {
        restaraunts: [], //大转盘奖品名称
        colors: [], //大转盘奖品区块对应背景颜色
        outsideRadius: 293, //大转盘外圆的半径
        textRadius: 200, //大转盘奖品位置距离圆心的距离
        insideRadius: 75, //大转盘内圆的半径
        startAngle: 0, //开始角度
        bRotate: false //false:停止;ture:旋转
    };

    $(document).ready(function() {
        //动态添加大转盘的奖品与奖品区域背景颜色4927
        turnplate.restaraunts = ["666元", "8元", "66元", "6元", "88元", "66元", "8元", "888元", "6元", "88元"];
        turnplate.colors = ["#fff278", "#09c0d2", "#fff278", "#09c0d2", "#fff278", "#09c0d2", "#fff278", "#09c0d2", "#fff278", "#09c0d2"];


        var rotateTimeOut = function() {
            $('#wheelcanvas').rotate({
                angle: 0,
                animateTo: 2160,
                duration: 8000,
                callback: function() {
                    alert('网络超时，请检查您的网络设置！');
                }
            });
        };

        //旋转转盘 item:奖品位置; txt：提示语;
        var rotateFn = function(item, txt) {
            console.info(360 / turnplate.restaraunts.length) ;
            var angles = item * (360 / turnplate.restaraunts.length) - (360 / (turnplate.restaraunts.length * 2)) - 72;
            if (angles < 270) {
                angles = 270 - angles;
            } else {
                angles = 360 - angles + 270;
            }
            console.info(angles) ;
            $('#wheelcanvas').stopRotate();
            $('#wheelcanvas').rotate({
                angle: 0,
                animateTo: angles + 1800,
                duration: 8000,
                callback: function() {
                    //showMask();
                    alert(txt);
                    turnplate.bRotate = !turnplate.bRotate;
                }
            });
        };

        $('.pointer').click(function (){

            if(turnplate.bRotate)return;

            $.ajax({
                url:"/doDraw",
                type:"POST",
                success:function(rsData){
                    //var rsData=JSON.parse(data);
                    // console.info(data.code) ;
                    console.info(rsData) ;
                    //console.info(rsData.code) ;

                    if(rsData.code=="200"){
                        var item = 1;
                        rotateFn(item, turnplate.restaraunts[item - 1]);

                    }else if(JSON.parse(rsData).code=="001003"){
                        layer.msg("登陆已失效，请重新登陆");
                        setTimeout(function(){
                            window.location.href=JSON.parse(rsData).url;
                        },2000)
                    }else{
                        alert(rsData.msg);
                    }
                }
            });
        });

    });


    //页面所有元素加载完毕后执行drawRouletteWheel()方法对转盘进行渲染
    window.onload = function() {
        drawRouletteWheel();
    };

    function drawRouletteWheel() {
        var canvas = document.getElementById("wheelcanvas");
        if (canvas.getContext) {
            //根据奖品个数计算圆周角度
            var arc = Math.PI / (turnplate.restaraunts.length / 2);
            var ctx = canvas.getContext("2d");
            //在给定矩形内清空一个矩形
            //ctx.clearRect(0,0,422,422);
            //strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式
            ctx.strokeStyle = "#FFBE04";
            //font 属性设置或返回画布上文本内容的当前字体属性
            ctx.font = '16px Microsoft YaHei';
            for (var i = 0; i < turnplate.restaraunts.length; i++) {
                var angle = turnplate.startAngle + i * arc;
                ctx.fillStyle = turnplate.colors[i];
                ctx.beginPath();
                //arc(x,y,r,起始角,结束角,绘制方向) 方法创建弧/曲线（用于创建圆或部分圆）
                ctx.arc(293, 293, turnplate.outsideRadius, angle, angle + arc, false);
                ctx.arc(293, 293, turnplate.insideRadius, angle + arc, angle, true);
                ctx.stroke();
                ctx.fill();
                //锁画布(为了保存之前的画布状态)
                ctx.save();

                //----绘制奖品开始----
                ctx.fillStyle = "#fff";
                var text_allin = turnplate.restaraunts;
                console.log(text_allin.indexOf("8"));
                var text = turnplate.restaraunts[i];
                console.log(text);
                var line_height = 17;
                //translate方法重新映射画布上的 (0,0) 位置
                ctx.translate(293 + Math.cos(angle + arc / 2) * turnplate.textRadius, 293 + Math.sin(angle + arc / 2) * turnplate.textRadius);
                console.log((angle + arc / 2 + Math.PI / 2));
                //rotate方法旋转当前的绘图
                ctx.rotate(angle + arc / 2 + Math.PI / 2 - 1.64); //-1.64定位

                /** 下面代码根据奖品类型、奖品名称长度渲染不同效果，如字体、颜色、图片效果。(具体根据实际情况改变) **/
                if (text.length == 2 && i % 2 == 0) { //偶数位86
                    var texts = text.split("元");
                    texts[1] = "元";
                    for (var j = 0; j < texts.length; j++) {
                        ctx.fillStyle = "#f4446a";
                        ctx.font = j == 0 ? 'bold 20px Microsoft YaHei' : 'bold 18px Microsoft YaHei';
                        ctx.textAlign = "center";
                        if (j == 0) {
                            ctx.fillText(texts[j], -ctx.measureText(texts[j]).width / 2, j * line_height + 6);
                        } else {
                            ctx.fillText(texts[j], 12, 5);
                        }
                    }
                } else if (text.length == 2 && i % 2 != 0) { //奇数位86
                    var texts = text.split("元");
                    texts[1] = "元";
                    for (var j = 0; j < texts.length; j++) {
                        ctx.fillStyle = "#fff";
                        ctx.font = j == 0 ? 'bold 20px Microsoft YaHei' : 'bold 18px Microsoft YaHei';
                        ctx.textAlign = "center";
                        if (j == 0) {
                            ctx.fillText(texts[j], -ctx.measureText(texts[j]).width / 2, j * line_height + 6);
                        } else {
                            ctx.fillText(texts[j], 12, 5);
                        }
                    }
                } else if (i % 2 != 0) { //偶数位其他
                    var texts = text.split("元");
                    texts[2] = "元";
                    for (var j = 0; j < texts.length; j++) {
                        ctx.font = j == 0 ? 'normal 28px Microsoft YaHei' : 'bold 18px Microsoft YaHei';
                        ctx.textAlign = "center";
                        if (j == 0) {
                            ctx.fillText(texts[j], -ctx.measureText(texts[j]).width / 2, j * line_height + 6);
                        } else {
                            ctx.fillText(texts[j], 12, 5);
                        }
                    }
                } else { //奇数位其他
                    var texts = text.split("元");
                    texts[2] = "元";
                    ctx.fillStyle = "#f4446a";
                    for (var j = 0; j < texts.length; j++) {
                        ctx.font = j == 0 ? 'normal 28px Microsoft YaHei' : 'bold 18px Microsoft YaHei';
                        ctx.textAlign = "center";
                        if (j == 0) {
                            ctx.fillText(texts[j], -ctx.measureText(texts[j]).width / 2, j * line_height + 6);
                        } else {
                            ctx.fillText(texts[j], 12, 5);
                        }
                    }
                }
                //把当前画布返回（调整）到上一个save()状态之前
                ctx.restore();
                //----绘制奖品结束----
            }
        }
    }

</script>

</body>
</html>