(function(){var e={},U=[],s=false,l;window.onload=function(){$focus($G("videoUrl"));t();i();w()};function t(){var r=$G("tabHeads").children;for(var e=0;e<r.length;e++){domUtils.on(r[e],"click",function(e){var t,i,a=e.target||e.srcElement;for(t=0;t<r.length;t++){i=r[t].getAttribute("data-content-id");if(r[t]==a){domUtils.addClass(r[t],"focus");domUtils.addClass($G(i),"focus")}else{domUtils.removeClasses(r[t],"focus");domUtils.removeClasses($G(i),"focus")}}})}}function i(){p(["videoFloat","upload_alignment"]);v($G("videoUrl"));a();(function(){var e=editor.selection.getRange().getClosedNode(),t;if(e&&e.className){var i=e.className=="edui-faked-video",a=e.className.indexOf("edui-upload-video")!=-1;if(i||a){$G("videoUrl").value=t=e.getAttribute("_url");$G("videoWidth").value=e.width;$G("videoHeight").value=e.height;var r=domUtils.getComputedStyle(e,"float"),o=domUtils.getComputedStyle(e.parentNode,"text-align");n(o==="center"?"center":r)}if(a){s=true}}g(t)})()}function a(){dialog.onok=function(){$G("preview").innerHTML="";var e=d("tabHeads","tabSrc");switch(e){case"video":return r();break;case"videoSearch":return o("searchList");break;case"upload":return h();break}};dialog.oncancel=function(){$G("preview").innerHTML=""}}function n(e){var t=$G("videoFloat").children;for(var i=0,a;a=t[i++];){if(a.getAttribute("name")==e){if(a.className!="focus"){a.className="focus"}}else{if(a.className=="focus"){a.className=""}}}}function r(){var e=$G("videoWidth"),t=$G("videoHeight"),i=$G("videoUrl").value,a=d("videoFloat","name");if(!i)return false;if(!c([e,t]))return false;editor.execCommand("insertvideo",{url:u(i),width:e.value,height:t.value,align:a},s?"upload":null)}function o(e){var t=domUtils.getElementsByTagName($G(e),"img"),i=[];for(var a=0,r;r=t[a++];){if(r.getAttribute("selected")){i.push({url:r.getAttribute("ue_video_url"),width:420,height:280,align:"none"})}}editor.execCommand("insertvideo",i)}function d(e,t){var i=$G(e).children,a;for(var r=0,o;o=i[r++];){if(o.className=="focus"){a=o.getAttribute(t);break}}return a}function u(e){if(!e)return"";e=utils.trim(e).replace(/v\.youku\.com\/v_show\/id_([\w\-=]+)\.html/i,"player.youku.com/player.php/sid/$1/v.swf").replace(/(www\.)?youtube\.com\/watch\?v=([\w\-]+)/i,"www.youtube.com/v/$2").replace(/youtu.be\/(\w+)$/i,"www.youtube.com/v/$1").replace(/v\.ku6\.com\/.+\/([\w\.]+)\.html.*$/i,"player.ku6.com/refer/$1/v.swf").replace(/www\.56\.com\/u\d+\/v_([\w\-]+)\.html/i,"player.56.com/v_$1.swf").replace(/www.56.com\/w\d+\/play_album\-aid\-\d+_vid\-([^.]+)\.html/i,"player.56.com/v_$1.swf").replace(/v\.pps\.tv\/play_([\w]+)\.html.*$/i,"player.pps.tv/player/sid/$1/v.swf").replace(/www\.letv\.com\/ptv\/vplay\/([\d]+)\.html.*$/i,"i7.imgs.letv.com/player/swfPlayer.swf?id=$1&autoplay=0").replace(/www\.tudou\.com\/programs\/view\/([\w\-]+)\/?/i,"www.tudou.com/v/$1").replace(/v\.qq\.com\/cover\/[\w]+\/[\w]+\/([\w]+)\.html/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/v\.qq\.com\/.+[\?\&]vid=([^&]+).*$/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/my\.tv\.sohu\.com\/[\w]+\/[\d]+\/([\d]+)\.shtml.*$/i,"share.vrs.sohu.com/my/v.swf&id=$1");return e}function c(e){for(var t=0,i;i=e[t++];){var a=i.value;if(!f(a)&&a){alert(lang.numError);i.value="";i.focus();return false}}return true}function f(e){return/(0|^[1-9]\d*$)/.test(e)}function p(e){for(var t=0,i;i=e[t++];){var a=$G(i),r={none:lang["default"],left:lang.floatLeft,right:lang.floatRight,center:lang.block};for(var o in r){var s=document.createElement("div");s.setAttribute("name",o);if(o=="none")s.className="focus";s.style.cssText="background:url(images/"+o+"_focus.jpg);";s.setAttribute("title",r[o]);a.appendChild(s)}m(i)}}function m(e){var i=$G(e).children;for(var t=0,a;a=i[t++];){domUtils.on(a,"click",function(){for(var e=0,t;t=i[e++];){t.className="";t.removeAttribute&&t.removeAttribute("class")}this.className="focus"})}}function v(e){if(browser.ie){e.onpropertychange=function(){g(this.value)}}else{e.addEventListener("input",function(){g(this.value)},false)}}function g(e){if(!e)return;var t=u(e);t=utils.unhtmlForUrl(t);$G("preview").innerHTML='<div class="previewMsg"><span>'+lang.urlError+"</span></div>"+'<embed class="previewVideo" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer"'+' src="'+t+'"'+' width="'+420+'"'+' height="'+280+'"'+' wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" >'+"</embed>"}function h(){var e=[],t=editor.getOpt("videoUrlPrefix"),i=parseInt($G("upload_width").value,10)||420,a=parseInt($G("upload_height").value,10)||280,r=d("upload_alignment","name")||"none";for(var o in U){var s=U[o];e.push({url:t+s.url,width:i,height:a,align:r})}var n=l.getQueueCount();if(n){$(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,n)+"</span>");return false}else{editor.execCommand("insertvideo",e,"upload")}}function w(){l=new b("queueList")}function b(e){this.$wrap=e.constructor==String?$("#"+e):$(e);this.init()}b.prototype={init:function(){this.fileList=[];this.initContainer();this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var a=this,d=jQuery,e=a.$wrap,r=e.find(".filelist"),o=e.find(".statusBar"),s=o.find(".info"),n=e.find(".uploadBtn"),t=e.find(".filePickerBtn"),u=e.find(".filePickerBlock"),l=e.find(".placeholder"),c=o.find(".progress").hide(),i=0,f=0,p=window.devicePixelRatio||1,m=113*p,v=113*p,g="",h={},w=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;e=null;return t}(),b,y=editor.getActionUrl(editor.getOpt("videoActionName")),$=editor.getOpt("videoMaxSize"),k=(editor.getOpt("videoAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");if(!WebUploader.Uploader.support()){d("#filePickerReady").after(d("<div>").html(lang.errorNotSupport)).hide();return}else if(!editor.getOpt("videoActionName")){d("#filePickerReady").after(d("<div>").html(lang.errorLoadConfig)).hide();return}b=a.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:y,fileVal:editor.getOpt("videoFieldName"),duplicate:true,fileSingleSizeLimit:$,compress:false});b.addButton({id:"#filePickerBlock"});b.addButton({id:"#filePickerBtn",label:lang.uploadAddFile});S("pedding");function C(i){var a=d('<li id="'+i.id+'">'+'<p class="title">'+i.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),r=d('<div class="file-panel">'+'<span class="cancel">'+lang.uploadDelete+"</span>"+'<span class="rotateRight">'+lang.uploadTurnRight+"</span>"+'<span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(a),o=a.find("p.progress span"),s=a.find("p.imgWrap"),n=d('<p class="error"></p>').hide().appendTo(a),l=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry;break}n.text(text).show()};if(i.getStatus()==="invalid"){l(i.statusText)}else{s.text(lang.uploadPreview);if("|png|jpg|jpeg|bmp|gif|".indexOf("|"+i.ext.toLowerCase()+"|")==-1){s.empty().addClass("notimage").append('<i class="file-preview file-type-'+i.ext.toLowerCase()+'"></i>'+'<span class="file-title">'+i.name+"</span>")}else{if(browser.ie&&browser.version<=7){s.text(lang.uploadNoPreview)}else{b.makeThumb(i,function(e,t){if(e||!t||/^data:/.test(t)&&browser.ie&&browser.version<=7){s.text(lang.uploadNoPreview)}else{var i=d('<img src="'+t+'">');s.empty().append(i);i.on("error",function(){s.text(lang.uploadNoPreview)})}},m,v)}}h[i.id]=[i.size,0];i.rotation=0;if(!i.ext||k.indexOf(i.ext.toLowerCase())==-1){l("not_allow_type");b.removeFile(i)}}i.on("statuschange",function(e,t){if(t==="progress"){o.hide().width(0)}else if(t==="queued"){a.off("mouseenter mouseleave");r.remove()}if(e==="error"||e==="invalid"){l(i.statusText);h[i.id][1]=1}else if(e==="interrupt"){l("interrupt")}else if(e==="queued"){h[i.id][1]=0}else if(e==="progress"){n.hide();o.css("display","block")}else if(e==="complete"){}a.removeClass("state-"+t).addClass("state-"+e)});a.on("mouseenter",function(){r.stop().animate({height:30})});a.on("mouseleave",function(){r.stop().animate({height:0})});r.on("click","span",function(){var e=d(this).index(),t;switch(e){case 0:b.removeFile(i);return;case 1:i.rotation+=90;break;case 2:i.rotation-=90;break}if(w){t="rotate("+i.rotation+"deg)";s.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})}else{s.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(i.rotation/90%4+4)%4+")")}});a.insertBefore(u)}function x(e){var t=d("#"+e.id);delete h[e.id];_();t.off().find(".file-panel").off().end().remove()}function _(){var i=0,a=0,e=c.children(),t;d.each(h,function(e,t){a+=t[0];i+=t[0]*t[1]});t=a?i/a:0;e.eq(0).text(Math.round(t*100)+"%");e.eq(1).css("width",Math.round(t*100)+"%");N()}function S(e,t){if(e!=g){var i=b.getStats();n.removeClass("state-"+g);n.addClass("state-"+e);switch(e){case"pedding":r.addClass("element-invisible");o.addClass("element-invisible");l.removeClass("element-invisible");c.hide();s.hide();b.refresh();break;case"ready":l.addClass("element-invisible");r.removeClass("element-invisible");o.removeClass("element-invisible");c.hide();s.show();n.text(lang.uploadStart);b.refresh();break;case"uploading":c.show();s.hide();n.text(lang.uploadPause);break;case"paused":c.show();s.hide();n.text(lang.uploadContinue);break;case"confirm":c.show();s.hide();n.text(lang.uploadStart);i=b.getStats();if(i.successNum&&!i.uploadFailNum){S("finish");return}break;case"finish":c.hide();s.show();if(i.uploadFailNum){n.text(lang.uploadRetry)}else{n.text(lang.uploadStart)}break}g=e;N()}if(!a.getQueueCount()){n.addClass("disabled")}else{n.removeClass("disabled")}}function N(){var e="",t;if(g==="ready"){e=lang.updateStatusReady.replace("_",i).replace("_KB",WebUploader.formatSize(f))}else if(g==="confirm"){t=b.getStats();if(t.uploadFailNum){e=lang.updateStatusConfirm.replace("_",t.successNum).replace("_",t.successNum)}}else{t=b.getStats();e=lang.updateStatusFinish.replace("_",i).replace("_KB",WebUploader.formatSize(f)).replace("_",t.successNum);if(t.uploadFailNum){e+=lang.updateStatusError.replace("_",t.uploadFailNum)}}s.html(e)}b.on("fileQueued",function(e){i++;f+=e.size;if(i===1){l.addClass("element-invisible");o.show()}C(e)});b.on("fileDequeued",function(e){i--;f-=e.size;x(e);_()});b.on("filesQueued",function(e){if(!b.isInProgress()&&(g=="pedding"||g=="finish"||g=="confirm"||g=="ready")){S("ready")}_()});b.on("all",function(e,t){switch(e){case"uploadFinished":S("confirm",t);break;case"startUpload":var i=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",a=utils.formatUrl(y+(y.indexOf("?")==-1?"?":"&")+"encode=utf-8&"+i);b.option("server",a);S("uploading",t);break;case"stopUpload":S("paused",t);break}});b.on("uploadBeforeSend",function(e,t,i){i["X_Requested_With"]="XMLHttpRequest"});b.on("uploadProgress",function(e,t){var i=d("#"+e.id),a=i.find(".progress span");a.css("width",t*100+"%");h[e.id][1]=t;_()});b.on("uploadSuccess",function(e,t){var i=d("#"+e.id);try{var a=t._raw||t,r=utils.str2json(a);if(r.state=="SUCCESS"){U.push({url:r.url,type:r.type,original:r.original});i.append('<span class="success"></span>')}else{i.find(".error").text(r.state).show()}}catch(e){i.find(".error").text(lang.errorServerUpload).show()}});b.on("uploadError",function(e,t){});b.on("error",function(e,t){if(e=="Q_TYPE_DENIED"||e=="F_EXCEED_SIZE"){C(t)}});b.on("uploadComplete",function(e,t){});n.on("click",function(){if(d(this).hasClass("disabled")){return false}if(g==="ready"){b.upload()}else if(g==="paused"){b.upload()}else if(g==="uploading"){b.stop()}});n.addClass("state-"+g);_()},getQueueCount:function(){var e,t,i,a=0,r=this.uploader.getFiles();for(t=0;e=r[t++];){i=e.getStatus();if(i=="queued"||i=="uploading"||i=="progress")a++}return a},refresh:function(){this.uploader.refresh()}}})();