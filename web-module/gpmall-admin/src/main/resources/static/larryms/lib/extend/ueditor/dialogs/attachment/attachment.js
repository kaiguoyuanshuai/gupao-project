(function(){var uploadFile,onlineFile;window.onload=function(){initTabs();initButtons()};function initTabs(){var e=$G("tabhead").children;for(var t=0;t<e.length;t++){domUtils.on(e[t],"click",function(e){var t=e.target||e.srcElement;setTabFocus(t.getAttribute("data-content-id"))})}setTabFocus("upload")}function setTabFocus(e){if(!e)return;var t,i,a=$G("tabhead").children;for(t=0;t<a.length;t++){i=a[t].getAttribute("data-content-id");if(i==e){domUtils.addClass(a[t],"focus");domUtils.addClass($G(i),"focus")}else{domUtils.removeClasses(a[t],"focus");domUtils.removeClasses($G(i),"focus")}}switch(e){case"upload":uploadFile=uploadFile||new UploadFile("queueList");break;case"online":onlineFile=onlineFile||new OnlineFile("fileList");break}}function initButtons(){dialog.onok=function(){var e=[],t,i=$G("tabhead").children;for(var a=0;a<i.length;a++){if(domUtils.hasClass(i[a],"focus")){t=i[a].getAttribute("data-content-id");break}}switch(t){case"upload":e=uploadFile.getInsertList();var s=uploadFile.getQueueCount();if(s){$(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,s)+"</span>");return false}break;case"online":e=onlineFile.getInsertList();break}editor.execCommand("insertfile",e)}}function UploadFile(e){this.$wrap=e.constructor==String?$("#"+e):$(e);this.init()}UploadFile.prototype={init:function(){this.fileList=[];this.initContainer();this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var n=this,d=jQuery,e=n.$wrap,a=e.find(".filelist"),s=e.find(".statusBar"),l=s.find(".info"),r=e.find(".uploadBtn"),t=e.find(".filePickerBtn"),u=e.find(".filePickerBlock"),o=e.find(".placeholder"),f=s.find(".progress").hide(),i=0,p=0,c=window.devicePixelRatio||1,h=113*c,g=113*c,m="",v={},b=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;e=null;return t}(),C,x=editor.getActionUrl(editor.getOpt("fileActionName")),w=editor.getOpt("fileMaxSize"),F=(editor.getOpt("fileAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");if(!WebUploader.Uploader.support()){d("#filePickerReady").after(d("<div>").html(lang.errorNotSupport)).hide();return}else if(!editor.getOpt("fileActionName")){d("#filePickerReady").after(d("<div>").html(lang.errorLoadConfig)).hide();return}C=n.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:x,fileVal:editor.getOpt("fileFieldName"),duplicate:true,fileSingleSizeLimit:w,compress:false});C.addButton({id:"#filePickerBlock"});C.addButton({id:"#filePickerBtn",label:lang.uploadAddFile});y("pedding");function U(i){var a=d('<li id="'+i.id+'">'+'<p class="title">'+i.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),s=d('<div class="file-panel">'+'<span class="cancel">'+lang.uploadDelete+"</span>"+'<span class="rotateRight">'+lang.uploadTurnRight+"</span>"+'<span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(a),n=a.find("p.progress span"),l=a.find("p.imgWrap"),r=d('<p class="error"></p>').hide().appendTo(a),o=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry;break}r.text(text).show()};if(i.getStatus()==="invalid"){o(i.statusText)}else{l.text(lang.uploadPreview);if("|png|jpg|jpeg|bmp|gif|".indexOf("|"+i.ext.toLowerCase()+"|")==-1){l.empty().addClass("notimage").append('<i class="file-preview file-type-'+i.ext.toLowerCase()+'"></i>'+'<span class="file-title" title="'+i.name+'">'+i.name+"</span>")}else{if(browser.ie&&browser.version<=7){l.text(lang.uploadNoPreview)}else{C.makeThumb(i,function(e,t){if(e||!t){l.text(lang.uploadNoPreview)}else{var i=d('<img src="'+t+'">');l.empty().append(i);i.on("error",function(){l.text(lang.uploadNoPreview)})}},h,g)}}v[i.id]=[i.size,0];i.rotation=0;if(!i.ext||F.indexOf(i.ext.toLowerCase())==-1){o("not_allow_type");C.removeFile(i)}}i.on("statuschange",function(e,t){if(t==="progress"){n.hide().width(0)}else if(t==="queued"){a.off("mouseenter mouseleave");s.remove()}if(e==="error"||e==="invalid"){o(i.statusText);v[i.id][1]=1}else if(e==="interrupt"){o("interrupt")}else if(e==="queued"){v[i.id][1]=0}else if(e==="progress"){r.hide();n.css("display","block")}else if(e==="complete"){}a.removeClass("state-"+t).addClass("state-"+e)});a.on("mouseenter",function(){s.stop().animate({height:30})});a.on("mouseleave",function(){s.stop().animate({height:0})});s.on("click","span",function(){var e=d(this).index(),t;switch(e){case 0:C.removeFile(i);return;case 1:i.rotation+=90;break;case 2:i.rotation-=90;break}if(b){t="rotate("+i.rotation+"deg)";l.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})}else{l.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(i.rotation/90%4+4)%4+")")}});a.insertBefore(u)}function k(e){var t=d("#"+e.id);delete v[e.id];S();t.off().find(".file-panel").off().end().remove()}function S(){var i=0,a=0,e=f.children(),t;d.each(v,function(e,t){a+=t[0];i+=t[0]*t[1]});t=a?i/a:0;e.eq(0).text(Math.round(t*100)+"%");e.eq(1).css("width",Math.round(t*100)+"%");_()}function y(e,t){if(e!=m){var i=C.getStats();r.removeClass("state-"+m);r.addClass("state-"+e);switch(e){case"pedding":a.addClass("element-invisible");s.addClass("element-invisible");o.removeClass("element-invisible");f.hide();l.hide();C.refresh();break;case"ready":o.addClass("element-invisible");a.removeClass("element-invisible");s.removeClass("element-invisible");f.hide();l.show();r.text(lang.uploadStart);C.refresh();break;case"uploading":f.show();l.hide();r.text(lang.uploadPause);break;case"paused":f.show();l.hide();r.text(lang.uploadContinue);break;case"confirm":f.show();l.hide();r.text(lang.uploadStart);i=C.getStats();if(i.successNum&&!i.uploadFailNum){y("finish");return}break;case"finish":f.hide();l.show();if(i.uploadFailNum){r.text(lang.uploadRetry)}else{r.text(lang.uploadStart)}break}m=e;_()}if(!n.getQueueCount()){r.addClass("disabled")}else{r.removeClass("disabled")}}function _(){var e="",t;if(m==="ready"){e=lang.updateStatusReady.replace("_",i).replace("_KB",WebUploader.formatSize(p))}else if(m==="confirm"){t=C.getStats();if(t.uploadFailNum){e=lang.updateStatusConfirm.replace("_",t.successNum).replace("_",t.successNum)}}else{t=C.getStats();e=lang.updateStatusFinish.replace("_",i).replace("_KB",WebUploader.formatSize(p)).replace("_",t.successNum);if(t.uploadFailNum){e+=lang.updateStatusError.replace("_",t.uploadFailNum)}}l.html(e)}C.on("fileQueued",function(e){i++;p+=e.size;if(i===1){o.addClass("element-invisible");s.show()}U(e)});C.on("fileDequeued",function(e){i--;p-=e.size;k(e);S()});C.on("filesQueued",function(e){if(!C.isInProgress()&&(m=="pedding"||m=="finish"||m=="confirm"||m=="ready")){y("ready")}S()});C.on("all",function(e,t){switch(e){case"uploadFinished":y("confirm",t);break;case"startUpload":var i=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",a=utils.formatUrl(x+(x.indexOf("?")==-1?"?":"&")+"encode=utf-8&"+i);C.option("server",a);y("uploading",t);break;case"stopUpload":y("paused",t);break}});C.on("uploadBeforeSend",function(e,t,i){i["X_Requested_With"]="XMLHttpRequest"});C.on("uploadProgress",function(e,t){var i=d("#"+e.id),a=i.find(".progress span");a.css("width",t*100+"%");v[e.id][1]=t;S()});C.on("uploadSuccess",function(e,t){var i=d("#"+e.id);try{var a=t._raw||t,s=utils.str2json(a);if(s.state=="SUCCESS"){n.fileList.push(s);i.append('<span class="success"></span>')}else{i.find(".error").text(s.state).show()}}catch(e){i.find(".error").text(lang.errorServerUpload).show()}});C.on("uploadError",function(e,t){});C.on("error",function(e,t){if(e=="Q_TYPE_DENIED"||e=="F_EXCEED_SIZE"){U(t)}});C.on("uploadComplete",function(e,t){});r.on("click",function(){if(d(this).hasClass("disabled")){return false}if(m==="ready"){C.upload()}else if(m==="paused"){C.upload()}else if(m==="uploading"){C.stop()}});r.addClass("state-"+m);S()},getQueueCount:function(){var e,t,i,a=0,s=this.uploader.getFiles();for(t=0;e=s[t++];){i=e.getStatus();if(i=="queued"||i=="uploading"||i=="progress")a++}return a},getInsertList:function(){var e,t,i,a=[],s=editor.getOpt("fileUrlPrefix");for(e=0;e<this.fileList.length;e++){i=this.fileList[e];t=i.url;a.push({title:i.original||t.substr(t.lastIndexOf("/")+1),url:s+t})}return a}};function OnlineFile(e){this.container=utils.isString(e)?document.getElementById(e):e;this.init()}OnlineFile.prototype={init:function(){this.initContainer();this.initEvents();this.initData()},initContainer:function(){this.container.innerHTML="";this.list=document.createElement("ul");this.clearFloat=document.createElement("li");domUtils.addClass(this.list,"list");domUtils.addClass(this.clearFloat,"clearFloat");this.list.appendChild(this.clearFloat);this.container.appendChild(this.list)},initEvents:function(){var i=this;domUtils.on($G("fileList"),"scroll",function(e){var t=this;if(t.scrollHeight-(t.offsetHeight+t.scrollTop)<10){i.getFileData()}});domUtils.on(this.list,"click",function(e){var t=e.target||e.srcElement,i=t.parentNode;if(i.tagName.toLowerCase()=="li"){if(domUtils.hasClass(i,"selected")){domUtils.removeClasses(i,"selected")}else{domUtils.addClass(i,"selected")}}})},initData:function(){this.state=0;this.listSize=editor.getOpt("fileManagerListSize");this.listIndex=0;this.listEnd=false;this.getFileData()},getFileData:function(){var _this=this;if(!_this.listEnd&&!this.isLoadingData){this.isLoadingData=true;ajax.request(editor.getActionUrl(editor.getOpt("fileManagerActionName")),{timeout:1e5,data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=eval("("+r.responseText+")");if(json.state=="SUCCESS"){_this.pushData(json.list);_this.listIndex=parseInt(json.start)+parseInt(json.list.length);if(_this.listIndex>=json.total){_this.listEnd=true}_this.isLoadingData=false}}catch(e){if(r.responseText.indexOf("ue_separate_ue")!=-1){var list=r.responseText.split(r.responseText);_this.pushData(list);_this.listIndex=parseInt(list.length);_this.listEnd=true;_this.isLoadingData=false}}},onerror:function(){_this.isLoadingData=false}})}},pushData:function(e){var t,i,a,s,n,l,r=this,o=editor.getOpt("fileManagerUrlPrefix");for(t=0;t<e.length;t++){if(e[t]&&e[t].url){i=document.createElement("li");l=document.createElement("span");s=e[t].url.substr(e[t].url.lastIndexOf(".")+1);if("png|jpg|jpeg|gif|bmp".indexOf(s)!=-1){n=document.createElement("img");domUtils.on(n,"load",function(e){return function(){r.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(n));n.width=113;n.setAttribute("src",o+e[t].url+(e[t].url.indexOf("?")==-1?"?noCache=":"&noCache=")+(+new Date).toString(36))}else{var d=document.createElement("i"),u=document.createElement("span");u.innerHTML=e[t].url.substr(e[t].url.lastIndexOf("/")+1);n=document.createElement("div");n.appendChild(d);n.appendChild(u);domUtils.addClass(n,"file-wrapper");domUtils.addClass(u,"file-title");domUtils.addClass(d,"file-type-"+s);domUtils.addClass(d,"file-preview")}domUtils.addClass(l,"icon");i.setAttribute("data-url",o+e[t].url);if(e[t].original){i.setAttribute("data-title",e[t].original)}i.appendChild(n);i.appendChild(l);this.list.insertBefore(i,this.clearFloat)}}},scale:function(e,t,i,a){var s=e.width,n=e.height;if(a=="justify"){if(s>=n){e.width=t;e.height=i*n/s;e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"}else{e.width=t*s/n;e.height=i;e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"}}else{if(s>=n){e.width=t*s/n;e.height=i;e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"}else{e.width=t;e.height=i*n/s;e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"}}},getInsertList:function(){var e,t=this.list.children,i=[];for(e=0;e<t.length;e++){if(domUtils.hasClass(t[e],"selected")){var a=t[e].getAttribute("data-url");var s=t[e].getAttribute("data-title")||a.substr(a.lastIndexOf("/")+1);i.push({title:s,url:a})}}return i}}})();