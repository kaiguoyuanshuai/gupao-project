(function(){var onlineImage,backupStyle=editor.queryCommandValue("background");window.onload=function(){initTabs();initColorSelector()};function initTabs(){var n=$G("tabHeads").children;for(var e=0;e<n.length;e++){domUtils.on(n[e],"click",function(e){var t=e.target||e.srcElement;for(var i=0;i<n.length;i++){if(n[i]==t){n[i].className="focus";var o=n[i].getAttribute("data-content-id");$G(o).style.display="block";if(o=="imgManager"){initImagePanel()}}else{n[i].className="";$G(n[i].getAttribute("data-content-id")).style.display="none"}}})}}function initColorSelector(){var e=editor.queryCommandValue("background");if(e){var t=e["background-color"],i=e["background-repeat"]||"repeat",o=e["background-image"]||"",n=e["background-position"]||"center center",a=n.split(" "),r=parseInt(a[0])||0,s=parseInt(a[1])||0;if(i=="no-repeat"&&(r||s))i="self";o=o.match(/url[\s]*\(([^\)]*)\)/);o=o?o[1]:"";updateFormState("colored",t,o,i,r,s)}else{updateFormState()}var l=function(){updateFormState();updateBackground()};domUtils.on($G("nocolorRadio"),"click",updateBackground);domUtils.on($G("coloredRadio"),"click",l);domUtils.on($G("url"),"keyup",function(){if($G("url").value&&$G("alignment").style.display=="none"){utils.each($G("repeatType").children,function(e){e.selected="repeat"==e.getAttribute("value")?"selected":false})}l()});domUtils.on($G("repeatType"),"change",l);domUtils.on($G("x"),"keyup",updateBackground);domUtils.on($G("y"),"keyup",updateBackground);initColorPicker()}function initColorPicker(){var e=editor,t=$G("colorPicker");var i=new UE.ui.Popup({content:new UE.ui.ColorPicker({noColorText:e.getLang("clearColor"),editor:e,onpickcolor:function(e,t){updateFormState("colored",t);updateBackground();UE.ui.Popup.postHide()},onpicknocolor:function(e,t){updateFormState("colored","transparent");updateBackground();UE.ui.Popup.postHide()}}),editor:e,onhide:function(){}});domUtils.on(t,"click",function(){i.showAnchor(this)});domUtils.on(document,"mousedown",function(e){var t=e.target||e.srcElement;UE.ui.Popup.postHide(t)});domUtils.on(window,"scroll",function(){UE.ui.Popup.postHide()})}function initImagePanel(){onlineImage=onlineImage||new OnlineImage("imageList")}function updateFormState(e,t,i,o,n,a){var r=$G("nocolorRadio"),s=$G("coloredRadio");if(e){r.checked=e=="colored"?false:"checked";s.checked=e=="colored"?"checked":false}if(t){domUtils.setStyle($G("colorPicker"),"background-color",t)}if(i&&/^\//.test(i)){var l=document.createElement("a");l.href=i;browser.ie&&(l.href=l.href);i=browser.ie?l.href:l.protocol+"//"+l.host+l.pathname+l.search+l.hash}if(i||i===""){$G("url").value=i}if(o){utils.each($G("repeatType").children,function(e){e.selected=o==e.getAttribute("value")?"selected":false})}if(n||a){$G("x").value=parseInt(n)||0;$G("y").value=parseInt(a)||0}$G("alignment").style.display=s.checked&&$G("url").value?"":"none";$G("custom").style.display=s.checked&&$G("url").value&&$G("repeatType").value=="self"?"":"none"}function updateBackground(){if($G("coloredRadio").checked){var e=domUtils.getStyle($G("colorPicker"),"background-color"),t=$G("url").value,i=$G("repeatType").value,o={"background-repeat":"no-repeat","background-position":"center center"};if(e)o["background-color"]=e;if(t)o["background-image"]="url("+t+")";if(i=="self"){o["background-position"]=$G("x").value+"px "+$G("y").value+"px"}else if(i=="repeat-x"||i=="repeat-y"||i=="repeat"){o["background-repeat"]=i}editor.execCommand("background",o)}else{editor.execCommand("background",null)}}function OnlineImage(e){this.container=utils.isString(e)?document.getElementById(e):e;this.init()}OnlineImage.prototype={init:function(){this.reset();this.initEvents()},initContainer:function(){this.container.innerHTML="";this.list=document.createElement("ul");this.clearFloat=document.createElement("li");domUtils.addClass(this.list,"list");domUtils.addClass(this.clearFloat,"clearFloat");this.list.id="imageListUl";this.list.appendChild(this.clearFloat);this.container.appendChild(this.list)},initEvents:function(){var i=this;domUtils.on($G("imageList"),"scroll",function(e){var t=this;if(t.scrollHeight-(t.offsetHeight+t.scrollTop)<10){i.getImageData()}});domUtils.on(this.container,"click",function(e){var t=e.target||e.srcElement,i=t.parentNode,o=$G("imageListUl").childNodes;if(i.tagName.toLowerCase()=="li"){updateFormState("nocolor",null,"");for(var n=0,a;a=o[n++];){if(a==i&&!domUtils.hasClass(a,"selected")){domUtils.addClass(a,"selected");updateFormState("colored",null,i.firstChild.getAttribute("_src"),"repeat")}else{domUtils.removeClasses(a,"selected")}}updateBackground()}})},initData:function(){this.state=0;this.listSize=editor.getOpt("imageManagerListSize");this.listIndex=0;this.listEnd=false;this.getImageData()},reset:function(){this.initContainer();this.initData()},getImageData:function(){var _this=this;if(!_this.listEnd&&!this.isLoadingData){this.isLoadingData=true;var url=editor.getActionUrl(editor.getOpt("imageManagerActionName")),isJsonp=utils.isCrossDomainUrl(url);ajax.request(url,{timeout:1e5,dataType:isJsonp?"jsonp":"",data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=isJsonp?r:eval("("+r.responseText+")");if(json.state=="SUCCESS"){_this.pushData(json.list);_this.listIndex=parseInt(json.start)+parseInt(json.list.length);if(_this.listIndex>=json.total){_this.listEnd=true}_this.isLoadingData=false}}catch(e){if(r.responseText.indexOf("ue_separate_ue")!=-1){var list=r.responseText.split(r.responseText);_this.pushData(list);_this.listIndex=parseInt(list.length);_this.listEnd=true;_this.isLoadingData=false}}},onerror:function(){_this.isLoadingData=false}})}},pushData:function(e){var t,i,o,n,a=this,r=editor.getOpt("imageManagerUrlPrefix");for(t=0;t<e.length;t++){if(e[t]&&e[t].url){i=document.createElement("li");o=document.createElement("img");n=document.createElement("span");domUtils.on(o,"load",function(e){return function(){a.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(o));o.width=113;o.setAttribute("src",r+e[t].url+(e[t].url.indexOf("?")==-1?"?noCache=":"&noCache=")+(+new Date).toString(36));o.setAttribute("_src",r+e[t].url);domUtils.addClass(n,"icon");i.appendChild(o);i.appendChild(n);this.list.insertBefore(i,this.clearFloat)}}},scale:function(e,t,i,o){var n=e.width,a=e.height;if(o=="justify"){if(n>=a){e.width=t;e.height=i*a/n;e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"}else{e.width=t*n/a;e.height=i;e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"}}else{if(n>=a){e.width=t*n/a;e.height=i;e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"}else{e.width=t;e.height=i*a/n;e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"}}},getInsertList:function(){var e,t=this.list.children,i=[],o=getAlign();for(e=0;e<t.length;e++){if(domUtils.hasClass(t[e],"selected")){var n=t[e].firstChild,a=n.getAttribute("_src");i.push({src:a,_src:a,floatStyle:o})}}return i}};dialog.onok=function(){updateBackground();editor.fireEvent("saveScene")};dialog.oncancel=function(){editor.execCommand("background",backupStyle)}})();