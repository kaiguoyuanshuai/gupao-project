var tableData=[],editorTable=null,chartsConfig=window.typeConfig,resizeTimer=null,currentChartType=0;window.onload=function(){editorTable=domUtils.findParentByTagName(editor.selection.getRange().startContainer,"table",true);if(!editorTable){document.body.innerHTML="<div class='edui-charts-not-data'>未找到数据</div>";return}initChartsTypeView();renderTable(editorTable);initEvent();initUserConfig(editorTable.getAttribute("data-chart"));$("#scrollBed .view-box:eq("+currentChartType+")").trigger("click");updateViewType(currentChartType);dialog.addListener("resize",function(){if(resizeTimer!=null){window.clearTimeout(resizeTimer)}resizeTimer=window.setTimeout(function(){resizeTimer=null;renderCharts()},500)})};function initChartsTypeView(){var e=[];for(var t=0,a=chartsConfig.length;t<a;t++){e.push('<div class="view-box" data-chart-type="'+t+'"><img width="300" src="images/charts'+t+'.png"></div>')}$("#scrollBed").html(e.join(""))}function renderTable(e){var t=[];for(var a=0,r;r=e.rows[a];a++){tableData[a]=[];t[a]=[];for(var i=0,n;n=r.cells[i];i++){var l=getCellValue(n);if(a>0&&i>0){l=+l}if(a===0||i===0){t[a].push("<th>"+l+"</th>")}else{t[a].push('<td><input type="text" class="data-item" value="'+l+'"></td>')}tableData[a][i]=l}t[a]=t[a].join("")}$("#tableContainer").html('<table id="showTable" border="1"><tbody><tr>'+t.join("</tr><tr>")+"</tr></tbody></table>")}function initUserConfig(e){var a={};if(!e){return}e=e.split(";");$.each(e,function(e,t){t=t.split(":");a[t[0]]=t[1]});setUserConfig(a)}function initEvent(){var e=null,t=chartsConfig.length-1,a=$("#scrollBed .view-box");$(".charts-format").delegate(".format-ctrl","change",function(){renderCharts()});$(".table-view").delegate(".data-item","focus",function(){e=this.value}).delegate(".data-item","blur",function(){if(this.value!==e){renderCharts()}e=null});$("#buttonContainer").delegate("a","click",function(e){e.preventDefault();if(this.getAttribute("data-title")==="prev"){if(currentChartType>0){currentChartType--;updateViewType(currentChartType)}}else{if(currentChartType<t){currentChartType++;updateViewType(currentChartType)}}});$("#scrollBed").delegate(".view-box","click",function(e){var t=$(this).attr("data-chart-type");a.removeClass("selected");$(a[t]).addClass("selected");currentChartType=t|0;if(currentChartType===chartsConfig.length-1){disableNotPieConfig()}else{enableNotPieConfig()}renderCharts()})}function renderCharts(){var e=collectData();$("#chartsContainer").highcharts($.extend({},chartsConfig[currentChartType],{credits:{enabled:false},exporting:{enabled:false},title:{text:e.title,x:-20},subtitle:{text:e.subTitle,x:-20},xAxis:{title:{text:e.xTitle},categories:e.categories},yAxis:{title:{text:e.yTitle},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{enabled:true,valueSuffix:e.suffix},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:1},series:e.series}))}function updateViewType(e){$("#scrollBed").css("marginLeft",-e*324+"px")}function collectData(){var e=document.forms["data-form"],t=null;if(currentChartType!==chartsConfig.length-1){t=getSeriesAndCategories();$.extend(t,getUserConfig())}else{t=getSeriesForPieChart();t.title=e["title"].value;t.suffix=e["unit"].value}return t}function getUserConfig(){var e=document.forms["data-form"],t={title:e["title"].value,subTitle:e["sub-title"].value,xTitle:e["x-title"].value,yTitle:e["y-title"].value,suffix:e["unit"].value,tableDataFormat:getTableDataFormat(),tip:$("#tipInput").val()};return t}function setUserConfig(e){var t=document.forms["data-form"];e.title&&(t["title"].value=e.title);e.subTitle&&(t["sub-title"].value=e.subTitle);e.xTitle&&(t["x-title"].value=e.xTitle);e.yTitle&&(t["y-title"].value=e.yTitle);e.suffix&&(t["unit"].value=e.suffix);e.dataFormat=="-1"&&(t["charts-format"][1].checked=true);e.tip&&(t["tip"].value=e.tip);currentChartType=e.chartType||0}function getSeriesAndCategories(){var e=document.forms["data-form"],t=[],a=[],r=[],i=getTableData();if(getTableDataFormat()==="-1"){for(var n=0,l=i.length;n<l;n++){for(var o=0,s=i[n].length;o<s;o++){if(!r[o]){r[o]=[]}r[o][n]=i[n][o]}}i=r}a=i[0].slice(1);for(var n=1,u;u=i[n];n++){t.push({name:u[0],data:u.slice(1)})}return{series:t,categories:a}}function getTableDataFormat(){var e=document.forms["data-form"],t=e["charts-format"];return t[0].checked?t[0].value:t[1].value}function disableNotPieConfig(){updateConfigItem("disable")}function enableNotPieConfig(){updateConfigItem("enable")}function updateConfigItem(e){var t=$("#showTable")[0],a=e==="disable"?true:false;for(var r=2,i;i=t.rows[r];r++){for(var n=1,l;l=i.cells[n];n++){$("input",l).attr("disabled",a)}}$("input.not-pie-item").attr("disabled",a);$("#tipInput").attr("disabled",!a)}function getSeriesForPieChart(){var e={type:"pie",name:$("#tipInput").val(),data:[]},t=getTableData();for(var a=1,r=t[0].length;a<r;a++){var i=t[0][a],n=t[1][a];e.data.push([i,n])}return{series:[e]}}function getTableData(){var e=document.getElementById("showTable"),t=e.rows[0].cells.length-1,a=getTableInputValue();for(var r=0,i;i=a[r];r++){tableData[Math.floor(r/t)+1][r%t+1]=a[r]}return tableData}function getTableInputValue(){var e=document.getElementById("showTable"),t=e.getElementsByTagName("input"),a=[];for(var r=0,i;i=t[r];r++){a.push(i.value|0)}return a}function getCellValue(e){var t=utils.trim(e.innerText||e.textContent||"");return t.replace(new RegExp(UE.dom.domUtils.fillChar,"g"),"").replace(/^\s+|\s+$/g,"")}dialog.onok=function(){var e=document.forms["data-form"],t=getUserConfig();t.chartType=currentChartType;syncTableData();editor.execCommand("charts",t)};function syncTableData(){var e=getTableData();for(var t=1,a;a=editorTable.rows[t];t++){for(var r=1,i;i=a.cells[r];r++){i.innerHTML=e[t][r]}}}