function Music(){this.init()}(function(){var o=[],p=[],t=null;Music.prototype={total:70,pageSize:10,dataUrl:"https://tingapi.b0.upaiyun.com/v1/restserver/ting?method=baidu.ting.search.common",playerUrl:"http://box.baidu.com/widget/flash/bdspacesong.swf",init:function(){var s=this;domUtils.on($G("J_searchName"),"keyup",function(e){var a=window.event||e;if(a.keyCode==13){s.dosearch()}});domUtils.on($G("J_searchBtn"),"click",function(){s.dosearch()})},callback:function(e){var a=this;a.data=e.song_list;setTimeout(function(){$G("J_resultBar").innerHTML=a._renderTemplate(e.song_list)},300)},dosearch:function(){var e=this;t=null;var a=$G("J_searchName").value;if(utils.trim(a)=="")return false;a=encodeURIComponent(a);e._sent(a)},doselect:function(e){var a=this;if(typeof e=="object"){t=e}else if(typeof e=="number"){t=a.data[e]}},onpageclick:function(e){var a=this;for(var s=0;s<o.length;s++){$G(o[s]).className="pageoff";$G(p[s]).className="paneloff"}$G("page"+e).className="pageon";$G("panel"+e).className="panelon"},listenTest:function(e){var a=this,s=$G("J_preview"),t=e.className=="m-try",n=a._getTryingElem();if(n){n.className="m-try";s.innerHTML=""}if(t){e.className="m-trying";s.innerHTML=a._buildMusicHtml(a._getUrl(true))}},_sent:function(e){var a=this;$G("J_resultBar").innerHTML='<div class="loading"></div>';utils.loadFile(document,{src:a.dataUrl+"&query="+e+"&page_size="+a.total+"&callback=music.callback&.r="+Math.random(),tag:"script",type:"text/javascript",defer:"defer"})},_removeHtml:function(e){var a=/<\s*\/?\s*[^>]*\s*>/gi;return e.replace(a,"")},_getUrl:function(e){var a=this;var s="from=tiebasongwidget&url=&name="+encodeURIComponent(a._removeHtml(t.title))+"&artist="+encodeURIComponent(a._removeHtml(t.author))+"&extra="+encodeURIComponent(a._removeHtml(t.album_title))+"&autoPlay="+e+""+"&loop=true";return a.playerUrl+"?"+s},_getTryingElem:function(){var e=$G("J_listPanel").getElementsByTagName("span");for(var a=0;a<e.length;a++){if(e[a].className=="m-trying")return e[a]}return null},_buildMusicHtml:function(e){var a='<embed class="BDE_try_Music" allowfullscreen="false" pluginspage="http://www.macromedia.com/go/getflashplayer"';a+=' src="'+e+'"';a+=' width="1" height="1" style="position:absolute;left:-2000px;"';a+=' type="application/x-shockwave-flash" wmode="transparent" play="true" loop="false"';a+=' menu="false" allowscriptaccess="never" scale="noborder">';return a},_byteLength:function(e){return e.replace(/[^\u0000-\u007f]/g,"aa").length},_getMaxText:function(e){var a=this;e=a._removeHtml(e);if(a._byteLength(e)>12)return e.substring(0,5)+"...";if(!e)e="&nbsp;";return e},_rebuildData:function(e){var a=this,s=[],t=a.pageSize,n;for(var i=0;i<e.length;i++){if((i+t)%t==0){n=[];s.push(n)}n.push(e[i])}return s},_renderTemplate:function(e){var a=this;if(e.length==0)return'<div class="empty">'+lang.emptyTxt+"</div>";e=a._rebuildData(e);var s=[],t=[],n=[];s.push('<div id="J_listPanel" class="listPanel">');t.push('<div class="page">');for(var i=0,l;l=e[i++];){p.push("panel"+i);o.push("page"+i);if(i==1){s.push('<div id="panel'+i+'" class="panelon">');if(e.length!=1){n.push('<div id="page'+i+'" onclick="music.onpageclick('+i+')" class="pageon">'+i+"</div>")}}else{s.push('<div id="panel'+i+'" class="paneloff">');n.push('<div id="page'+i+'" onclick="music.onpageclick('+i+')" class="pageoff">'+i+"</div>")}s.push('<div class="m-box">');s.push('<div class="m-h"><span class="m-t">'+lang.chapter+'</span><span class="m-s">'+lang.singer+'</span><span class="m-z">'+lang.special+'</span><span class="m-try-t">'+lang.listenTest+"</span></div>");for(var r=0,c;c=l[r++];){s.push('<label for="radio-'+i+"-"+r+'" class="m-m">');s.push('<input type="radio" id="radio-'+i+"-"+r+'" name="musicId" class="m-l" onclick="music.doselect('+(a.pageSize*(i-1)+(r-1))+')"/>');s.push('<span class="m-t">'+a._getMaxText(c.title)+"</span>");s.push('<span class="m-s">'+a._getMaxText(c.author)+"</span>");s.push('<span class="m-z">'+a._getMaxText(c.album_title)+"</span>");s.push('<span class="m-try" onclick="music.doselect('+(a.pageSize*(i-1)+(r-1))+');music.listenTest(this)"></span>');s.push("</label>")}s.push("</div>");s.push("</div>")}n.reverse();t.push(n.join(""));s.push("</div>");t.push("</div>");return s.join("")+t.join("")},exec:function(){var e=this;if(t==null)return;$G("J_preview").innerHTML="";editor.execCommand("music",{url:e._getUrl(false),width:400,height:95})}}})();